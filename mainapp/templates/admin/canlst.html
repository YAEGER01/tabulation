{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'admin/cssdesign/design.css' %}"/>
<center>
<table style="border:0px; width:75%">
<tr>
<td style="border:0px; width:75%"><b>List of Aspirant</b></td>
<td style="border:0px; width: 25%;">
    <a href="#" id="itemadd"><img src="{% static 'icon/note-add-icon.png' %}" alt="" style="width: 30px; height: 30px;"/><b>New</b></a>
    <a href="#" onclick="window.location.reload();"><img src="{% static 'icon/refresh.png' %}" alt="" style="width: 30px; height: 30px;"/><b>Refresh</b></a>
</td>
</tr>
</table>

<div id="formitem" style="display:none; position:fixed; top:12%; left:50%; transform:translate(-50%, 0); width:480px; max-width:95vw; z-index:1000; background:#fff; border-radius:12px; box-shadow:0 8px 32px #888; border:2px solid #4CAF50;">
    <div style="background: linear-gradient(to bottom, #e0e0e0 0%, #bdbdbd 100%); border-radius:12px 12px 0 0; padding:14px 20px 10px 20px; border-bottom:2px solid #4CAF50; display:flex; align-items:center; justify-content:space-between;">
        <span style="font-size: 22px; font-weight: bold; color:#222;">Add Record</span>
        <button type="button" onclick="$('#formitem').hide();" style="background:none; border:none; font-size:22px; font-weight:bold; color:#444; cursor:pointer;">&times;</button>
    </div>
    <div style="padding: 18px 28px 0 28px;">
    <p class="tipsfields" style="font-size: 15px; text-align:center; margin-bottom:14px;">All form fields are required.</p>
    <form name="saveaspirant" id="saveaspirant" method="post" action="/admin/addaspirant/" style="margin:0;">
        <input type="hidden" name="sconid" id="sconid" value="" />
        {% csrf_token %}
        <fieldset style="border:none; padding:0; margin:0;">
            <table style="width:100%; border:none; margin:0 auto;">
                <tr>
                    <td style="width:38%; padding:6px 0 6px 0; text-align:right;"><label for="category" style="font-size: 15px; font-weight:600;">Category</label></td>
                    <td style="padding:6px 0 6px 12px;">
                        <select id="category" name="category" style="font-size: 15px; width: 100%; height: 32px; border-radius:6px; border:1px solid #ccc; padding:4px; background:#fafafa;" required>
                            <option value="">Select</option>
                            <option value="Mr.">Mr.</option>
                            <option value="Ms.">Ms.</option>
                            <option value="Other">Other</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td style="padding:6px 0 6px 0; text-align:right;"><label for="optevent" style="font-size: 15px; font-weight:600;">Event</label></td>
                    <td style="padding:6px 0 6px 12px;">
                        <select id="optevent" name="optevent" style="font-size: 15px; width: 100%; height: 32px; border-radius:6px; border:1px solid #ccc; padding:4px; background:#fafafa;" required>
                            <option value="">Select</option>
                            {% for event in events %}
                                <option value="{{ event.evid }}">{{ event.evdes }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <td style="padding:6px 0 6px 0; text-align:right;"><label for="cano" style="font-size: 15px; font-weight:600;">Contestant Number</label></td>
                    <td style="padding:6px 0 6px 12px;">
                        <input type="number" name="cano" id="cano" style="font-size: 15px; width: 100%; border-radius:6px; border:1px solid #ccc; padding:4px; background:#fafafa;" required/>
                    </td>
                </tr>
                <tr>
                    <td style="padding:6px 0 6px 0; text-align:right;"><label for="cname" style="font-size: 15px; font-weight:600;">Name</label></td>
                    <td style="padding:6px 0 6px 12px;">
                        <input type="text" name="cname" id="cname" style="font-size: 15px; width: 100%; border-radius:6px; border:1px solid #ccc; padding:4px; background:#fafafa;" maxlength="100" required/>
                    </td>
                </tr>
                <tr>
                    <td style="padding:6px 0 6px 0; text-align:right;"><label for="course" style="font-size: 15px; font-weight:600;">Course</label></td>
                    <td style="padding:6px 0 6px 12px;">
                        <input type="text" name="course" id="course" style="font-size: 15px; width: 100%; border-radius:6px; border:1px solid #ccc; padding:4px; background:#fafafa;" maxlength="50" required/>
                    </td>
                </tr>
            </table>
            <div style="text-align:center; margin-top:18px; margin-bottom:10px;">
                <button type="submit" class="CSSButton" id="saveBtn" style="width: 110px; font-size: 16px; margin-right: 16px; border-radius:7px; background: linear-gradient(to bottom, #f5f5f5 0%, #e0e0e0 100%); border:2px solid #4CAF50; box-shadow:0 2px 4px #eee;">Save</button>
                <button type="button" class="CSSButton" style="width: 110px; font-size: 16px; border-radius:7px; background: linear-gradient(to bottom, #f5f5f5 0%, #e0e0e0 100%); border:2px solid #4CAF50; box-shadow:0 2px 4px #eee;" onclick="$('#formitem').hide();">Cancel</button>
            </div>
        </fieldset>
    </form>
    </div>
</div>

{% for group in event_candidates %}
    <div style="margin-bottom: 18px;">
    <div style="font-size: 15px; font-weight: bold; margin-bottom: 2px;">{{ group.event.evdes }}</div>
    <table style="width: 80%; margin: 0 auto 8px auto; border-collapse: collapse; border: 2px solid #008000; background: #fff;">
        <tr style="background: #e6f9e6;">
            <th style="width:8%; border: 1px solid #008000; padding: 6px 0; font-size: 15px; font-weight: bold; text-align: center;">No.</th>
            <th style="width:10%; border: 1px solid #008000; padding: 6px 0; font-size: 15px; font-weight: bold; text-align: center;">Status</th>
            <th style="width:28%; border: 1px solid #008000; padding: 6px 0; font-size: 15px; font-weight: bold; text-align: center;">Title</th>
            <th style="width:18%; border: 1px solid #008000; padding: 6px 0; font-size: 15px; font-weight: bold; text-align: center;">Category</th>
            <th style="width:18%; border: 1px solid #008000; padding: 6px 0; font-size: 15px; font-weight: bold; text-align: center;">Event</th>
            <th style="width:18%; border: 1px solid #008000; padding: 6px 0; font-size: 15px; font-weight: bold; text-align: center;"></th>
        </tr>
        {% for candidate in group.candidates %}
        <tr style="border: 1px solid #008000;">
            <td style="border: 1px solid #008000; text-align: center; padding: 5px 0; font-size: 15px;">{{ candidate.cano }}</td>
            <td style="border: 1px solid #008000; text-align: center; padding: 5px 0;">
                <input type="checkbox" class="toggle-candidate" data-sconid="{{ candidate.sconid }}" data-event="{{ group.event.evid }}" {% if candidate.canstatus == '1' %}checked{% endif %}>
            </td>
            <td style="border: 1px solid #008000; text-align: center; padding: 5px 0; font-size: 15px;">{{ candidate.cname }}</td>
            <td style="border: 1px solid #008000; text-align: center; padding: 5px 0; font-size: 15px;">{{ candidate.category }}</td>
            <td style="border: 1px solid #008000; text-align: center; padding: 5px 0; font-size: 15px;">{{ group.event.evdes }}</td>
            <td style="border: 1px solid #008000; text-align: center; padding: 5px 0;">
                <img src="{% static 'icon/mail_new.png' %}" alt="Edit" title="Edit" class="edit-aspirant"
                    data-id="{{ candidate.sconid }}"
                    data-cano="{{ candidate.cano }}"
                    data-cname="{{ candidate.cname|escapejs }}"
                    data-category="{{ candidate.category|escapejs }}"
                    data-course="{{ candidate.course|escapejs }}"
                    data-event="{{ group.event.evid }}"
                    style="width: 24px; height: 24px; margin-right: 8px; cursor: pointer; vertical-align: middle;" />
                <img src="{% static 'icon/delete-icon.png' %}" alt="Delete" title="Delete" class="delete-aspirant" data-id="{{ candidate.sconid }}" style="width: 24px; height: 24px; cursor: pointer; vertical-align: middle;" />
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" style="text-align:center; border: 1px solid #008000; padding: 8px 0; font-size: 15px;">No aspirants for this event.</td></tr>
        {% endfor %}
    </table>
    </div>
{% endfor %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function() {
    // New button (event delegation)
    $(document).on('click', '#itemadd', function(e) {
        e.preventDefault();
        $('#saveaspirant')[0].reset();
        $('#sconid').val('');
        $('#formitem').find('span[style*="font-size: 22px"]').text('Add Record');
        $('#saveBtn').text('Save');
        $('#formitem').show();
    });

    // Edit button (event delegation)
    $(document).on('click', '.edit-aspirant', function(e) {
        e.preventDefault();
        var id = $(this).data('id');
        var cano = $(this).data('cano');
        var cname = $(this).data('cname');
        var category = $(this).data('category');
        var course = $(this).data('course');
        var eventid = $(this).data('event');
        $('#saveaspirant')[0].reset();
        $('#sconid').val(id);
        $('#cano').val(cano);
        $('#cname').val(cname);
        $('#category').val(category);
        $('#course').val(course);
        $('#optevent').val(eventid);
        $('#formitem').find('span[style*="font-size: 22px"]').text('Edit Record');
        $('#saveBtn').text('Update');
        $('#formitem').show();
    });

    // Delete button (event delegation)
    $(document).on('click', '.delete-aspirant', function(e) {
        e.preventDefault();
        var id = $(this).data('id');
        if (confirm('Are you sure you want to delete this aspirant?')) {
            window.location.href = '/admin/deleteaspirant/' + id + '/';
        }
    });

    // Ensure modal closes after submit (for both add and edit)
    $('#saveaspirant').on('submit', function() {
        $('#formitem').hide();
    });
    // CSRF helper
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    // Inline toggle for aspirant status
    $(document).on('change', '.toggle-candidate', function() {
        var $chk = $(this);
        var sconid = $chk.data('sconid');
        var val = $chk.is(':checked') ? '1' : '0';
        $.ajax({
            url: "{% url 'toggle_candidate_status' %}",
            method: 'POST',
            data: { sconid: sconid, status: val },
            headers: { 'X-CSRFToken': csrftoken },
        })
        .done(function(resp) {
            if (!resp || !resp.ok) {
                alert('Failed to update aspirant status');
                $chk.prop('checked', !$chk.is(':checked'));
            } else {
                // notify other tabs/windows: include event id so judges viewing that event can refresh
                var ev = $chk.data('event');
                try { localStorage.setItem('candidate-status-changed', JSON.stringify({ event: ev, sconid: sconid, status: val, t: Date.now() })); } catch(e) { /* ignore */ }
                // BroadcastChannel for same-origin immediate updates across tabs
                try {
                    if (typeof BroadcastChannel !== 'undefined') {
                        var ch = new BroadcastChannel('candidate_updates');
                        ch.postMessage({ event: ev, sconid: sconid, status: val, t: Date.now() });
                        ch.close();
                    }
                } catch(bcerr) { console.warn('bc post failed', bcerr); }
                console.log('candidate toggle success', { ev: ev, sconid: sconid, status: val });
            }
        })
        .fail(function() {
            alert('Failed to update aspirant status (server error)');
            $chk.prop('checked', !$chk.is(':checked'));
        });
    });
});
</script>
</script>
</center>
{% endblock %}
